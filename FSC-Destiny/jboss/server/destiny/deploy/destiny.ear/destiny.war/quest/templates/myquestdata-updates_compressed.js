Class.create(BaseController,{init:function(){var b=Registry.lookup("MyQuestController.Loader");$("searchtemplate").removeClassName("home");$("searchtemplate").removeClassName("search");$("searchtemplate").addClassName("bookClub");var d=this.data;this.menu=Registry.lookup("MyQuestController.Menu");if(d.inboxCount>=0){this.menu.updateInboxCount(d.inboxCount)}var c=this.template.render(d);b.updateContent(c);this.shelfSelect=new ShelfSelect({id:"myQuestMainContent"});var e=$("myQuestMainContentWrapper");this.updatesList=null;$("myQuestMainContentWrapper").className="myQuestUpdates";var a=d.todayStr;if(e.hasClassName("myQuestUpdates")){this.updatesList=new MyQuestList({resultsDivID:"myQuestMainContent",rowClass:"myQuestItem",todayStr:a,emptyStr:MessageHelper.format("myQuestUpdatesController_youHaveNoUpdates")})}e.show();this.currentMode=d.mapping;this.disableOnLoading();if(!DAO.load({endpoint:"MyQuestUpdatesController.OlderLoader",container:$(MyQuestUpdatesController_DIV_MYQUEST_UPDATES_RESULTS)},20,null,-1,"")){this.enableOnLoading()
}},registerEvents:function(){if($("myQuestUpdatesResults")){Event.stopObserving("myQuestUpdatesResults");Event.observe($("myQuestUpdatesResults"),"mousedown",this.prefsListener.bindAsEventListener(this));Event.observe("myQuestUpdatesResults","click",this.showCommentBox.bindAsEventListener(this));Event.observe("myQuestUpdatesResults","click",this.addComment.bindAsEventListener(this));Event.observe("myQuestUpdatesResults","keyup",this.addCommentAsYouTypeListener.bindAsEventListener(this));Event.observe("myQuestUpdatesResults","click",this.showAllComments.bindAsEventListener(this));Event.observe("myQuestUpdatesResults","click",this.doReportAbuse.bindAsEventListener(this));Event.observe("myQuestUpdatesResults","click",this.showHideDateGroups.bindAsEventListener(this))}Event.stopObserving("myQuestMainContent");Event.observe("myQuestMainContent","mousedown",this.determineAction.bindAsEventListener(this));Event.stopObserving("myQuestFooter");Event.observe("myQuestFooter","click",this.loadOlderOrNewerResults.bindAsEventListener(this))
},disableOnLoading:function(){if($(MyQuestUpdatesController_ID_MYQUEST_UPDATES_LOADING)){$(MyQuestUpdatesController_ID_MYQUEST_UPDATES_LOADING).show()}if($(MyQuestUpdatesController_ID_MYQUEST_OLDER_RESULTS_LINK)){$(MyQuestUpdatesController_ID_MYQUEST_OLDER_RESULTS_LINK).hide()}this.setLoading(true)},enableOnLoading:function(){if($(MyQuestUpdatesController_ID_MYQUEST_UPDATES_LOADING)){$(MyQuestUpdatesController_ID_MYQUEST_UPDATES_LOADING).hide()}var a=Registry.lookup("MyQuestUpdatesController.OlderLoader");if(a){a.refreshFooter()}this.setLoading(false)},setLoading:function(a){this.isLoading=a},doReportAbuse:function(b){var d=Event.element(b);if(d.hasClassName(MyQuestUpdatesController_CLASS_MYQUEST_REPORT_ABUSE)){var g=Utility.upToClass(d,"myQuestUpdatesItem");if(g){var c=Utility.downToClass(g,"conversationID").readAttribute("value")}else{g=Utility.upToClass(d,"myQuestShelfItem");var f=g.getAttribute("rowid")}var e={width:"610",id:ReportAbuseController_DIV_REPORT_ABUSE_DIALOG,zIndex:"50000",hideOnOutsideClick:"true"};
var a=new ModalDialog(e);DAO.load({endpoint:"ReportAbuseController.ReportAbuseDialog",modal:a},c,f)}},showHideDateGroups:function(event){if(!this.isLoading){var eventSource=Event.element(event);if(eventSource.hasClassName(MyQuestController_CLASS_MYQUEST_DATE_GROUP_EXPAND)||eventSource.hasClassName(MyQuestController_CLASS_MYQUEST_DATE_GROUP_COLLAPSE)){var idx=eventSource.readAttribute("id");var olderLoader=Registry.lookup("MyQuestUpdatesController.OlderLoader");var lastAuditID=olderLoader.getLastAuditIDForDateGroup(idx);olderLoader.truncateResults(idx);this.disableOnLoading();if(!DAO.load({endpoint:"MyQuestUpdatesController.OlderLoader",appendTo:"MyQuestUpdatesController.OlderLoader"},10,lastAuditID,eval(idx)-1,"",idx)){this.enableOnLoading()}}}},showAllComments:function(b){var d=Event.element(b);if(d.hasClassName(MyQuestUpdatesController_CLASS_MYQUEST_VIEW_ALL_COMMENT)){var e=Utility.upToClass(d,"myQuestUpdatesItem");var a=Utility.downToClass(e,"auditID").readAttribute("value");var c=Utility.downToClass(e,"conversationID").readAttribute("value");
DAO.load({endpoint:"MyQuestUpdatesController.AllComments",container:null},a,c)}},showCommentBox:function(f){var g=Event.element(f);if(g.hasClassName(MyQuestController_CLASS_MYQUEST_ADD_A_COMMENT)){var h=Utility.upToClass(g,"myQuestUpdatesItem");var a=Utility.downToClass(h,"auditID").readAttribute("value");var e=MyQuestController_LI_MY_QUEST_ADD_COMMENT_BOX_PREFIX+a;var c=$(e);if(!c){c=Utility.downToClass($(window.newRowID),"myQuestAddCommentWrapper")}if(c){c=c.up()}if(c&&!c.visible()){var b=Utility.downToClass(h,"myQuestAddCommentCharValue");if(b){b.innerHTML=255}if(this.commentBoxThing){var d=$("myQuestUpdatesResults");this.restoreOldAuditRow(d);d.oldRow=null;if(this.commentBoxThing.visible()){this.commentBoxThing.hide()}}c.show();this.commentBoxThing=c}this.focusCommentBox(a)}},restoreOldAuditRow:function(b){if(b.oldRow){var a=$$(".auditID[value="+b.newAuditID+"]")[0];if(a){var c=Utility.upToClass(a,"myQuestUpdatesItem");Element.insert(c,{before:b.oldRow});c.remove();b.newRowID=null}}},addComment:function(c){var e=Event.element(c);
var i=Utility.upToClass(e,"myQuestAddCommentButton");if(i){var a=i.readAttribute("value");var k=Utility.upToClass(e,"myQuestUpdatesItem");var d=Utility.downToClass(k,"auditID");var f=d.readAttribute("value");var b=Utility.downToClass(k,"conversationID");var l=b.readAttribute("value");var h=Utility.upToClass(e,"myQuestAddCommentWrapper");var j=Utility.downToClass(h,MyQuestUpdatesController_CLASS_MY_QUEST_ADD_COMMENT_BOX);var g=j.value;if(g&&!g.blank()){j.value="";DAO.load({endpoint:"MyQuestUpdatesController.MyQuestCommentAdd",container:null},f,l,g,k.identify(),a)}}},addCommentAsYouTypeListener:function(b){var c=Event.element(b);if(c.hasClassName("myQuestAddCommentBox")){var d=Utility.upToClass(c,"myQuestAddCommentWrapper");var a=Utility.downToClass(d,"myQuestAddCommentCharValue");if(c.value.length>255){c.value=c.value.substring(0,255)}if(c.value.length>235){a.addClassName("warnCharLeft")}if(c.value.length<=235&&a.hasClassName("warnCharLeft")){a.removeClassName("warnCharLeft")}a.innerHTML=255-c.value.length
}},focusCommentBox:function(b){var c=$("myQuestAddCommentBoxLI_"+b);if(c){var a=Utility.downToClass(c,MyQuestController_CLASS_MY_QUEST_ADD_COMMENT_BOX);if(a&&a.visible()){a.focus()}}},loadOlderOrNewerResults:function(b){var c=Event.element(b);var e=ReusableTemplates.load("EmptyImageTemplate",{id:"loading",styleClass:"loading",altText:"loading_string"});if(c.identify()==="myQuestEarlierPostControlLink"){var a=Registry.lookup("MyQuestUpdatesController.OlderLoader");var d=a.getLastAuditID();this.disableOnLoading();if(!DAO.load({endpoint:"MyQuestUpdatesController.OlderLoader",appendTo:"MyQuestUpdatesController.OlderLoader"},10,d,a.getLastDateGroupIdx(),a.getLastDateString())){this.enableOnLoading()}}},determineAction:function(b){if($("myQuestMainContentWrapper").className!="myQuestFriends"){var d=Event.element(b);var e=b.target.up(".myQuestFriendsItem");if(e){var a=e.getAttribute("rowid");if(d.hasClassName("myQuestControlDecline")){e.down(".myQuestControlWrapper").hide();DAO.load({endpoint:"MyQuestFriendsController.RemoveFriend",container:null},a,this.getCurrentMode())
}else{if(d.hasClassName("myQuestControlAccept")){e.down(".myQuestControlWrapper").hide();DAO.load({endpoint:"MyQuestFriendsController.AddFriend",container:null},a,this.getCurrentMode())}}}if(d.hasClassName("myQuestRecommendationRemove")){var e=b.target.up(".myQuestShelfItem");e.down(".myQuestShelfControlWrapper").hide();e.down(".myQuestRecommendationRemove").hide();var c=e.getAttribute("rowid");DAO.load({endpoint:"MyQuestUpdatesController.RecommendationRemove",container:null},c)}}},removeFriendCallback:function(a){if(this.updatesList){this.updatesList.removeRow(a.userID,null,function(){var b=MyQuestFriendsController_MAPPING_INBOX;var c=$(MyQuestController_DIV_MYQUEST_MAIN_CONTENT_WRAPPER);b=MyQuestFriendsController_MAPPING_UPDATES;c.fire(MyQuestFriendsController_EVENT_MYQUEST_OPTION_CLICK,{mapping:b})})}if(a.inboxCount>=0){$(MyQuestController_SPAN_MYQUEST_LEFT_INBOX_COUNT).update(a.inboxCount)}},addFriendCallback:function(a){if(this.updatesList){var b=$$(".myQuestItem[rowid="+a.userID+"] > .column2 > .myQuestFriendsFullName > .myQuestPatronName")[0].innerHTML;
this.updatesList.removeRow(a.userID,MessageHelper.format("myQuestInboxController_someoneHasBeenAddedToYourFriends",b),null)}if(a.inboxCount>=0){var c=Registry.lookup("MyQuestController.Menu");$(MyQuestController_SPAN_MYQUEST_LEFT_INBOX_COUNT).update(a.inboxCount)}},removeRecommendationCallback:function(a){if(this.updatesList){this.updatesList.removeRow(a.recommendationID,null,null)}if(a.inboxCount>=0){var b=Registry.lookup("MyQuestController.Menu");$(MyQuestController_SPAN_MYQUEST_LEFT_INBOX_COUNT).update(a.inboxCount)}},prefsListener:function(c){var b=Event.element(c);if(b.hasClassName("myQuestShelfPreferencesLink")){var a=Registry.lookup("MyQuestController.Loader");a.updateWrapperClass("myQuestPref");DAO.load({endpoint:"MyQuestPreferencesController.Loader",container:a.elementMap.get(MyQuestController_DIV_MYQUEST_MAIN_CONTENT)})}},getCurrentMode:function(){return this.currentMode}});