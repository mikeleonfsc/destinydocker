Class.create(BaseController,{init:function(){var json=this.data;if(json){this.auditID=eval(json.auditID);json.record.canComment=json.canComment;json.record.approvalNotRequired=json.approvalNotRequired;var results=$("myQuestUpdatesResults");if(this.commentBoxThing){this.commentBoxThing.hide()}var updates=Registry.lookup("MyQuestUpdatesController.Loader");updates.restoreOldAuditRow(results);this.insertNewAuditRow(results,json);this.renderComments(json);this.hideViewComments(json.canComment);commentBoxThing=$(MyQuestUpdatesController_LI_MY_QUEST_ADD_COMMENT_BOX_PREFIX+this.auditID);commentBoxThing.up().show()}},insertNewAuditRow:function(results,json){var commentBoxThing=$(MyQuestUpdatesController_LI_MY_QUEST_ADD_COMMENT_BOX_PREFIX+this.auditID);var currentRow=Utility.upToClass(commentBoxThing,"myQuestUpdatesItem");results.oldRow=currentRow;var ejs=new EJS({url:json.record.template});json.record.index=eval(json.auditID);var newHTML=ejs.render(json.record);Element.insert(currentRow,{before:newHTML});
this.auditID=json.record.auditID;results.newAuditID=this.auditID;currentRow.remove()},renderComments:function(c){var a=this.generateCommentsHTML(c);var b=$("commentSection"+this.auditID);b.update(a.html);b.show();var d=$$(".myQuestAddedCommentWrapper[commentID="+a.lastDisplayable+"]")[0];d.addClassName("lastDisplayable")},hideViewComments:function(b){var a=$("commentSection"+this.auditID).previous(".myQuestUpdatesToolbar");var c="";if(b){c="<a href='#' class='myQuestAddAComment' onclick='return false;'>Add a comment</a> | "}c+="<a href='#' class='myQuestReportAbuse' onclick='return false;'>Report Abuse</a>";a.update(c)},generateCommentsHTML:function(n){var c=n.comments.length;var h=5;var e="";if(c>h){var b="";var g="";g+="<ul id='' class='myQuestCommentsWrapper myQuestCommentsCollapsed'>";g+="<li id='' class='myQuestAddedCommentWrapper'>";g+="<div id='' class='myQuestTextButtonWrapper myQuestTextButtonWrapperAsHeader'>";g+="<a id='' class='myQuestTextButton icon iconExpandComments' href='#' onclick='return false;'>";
g+="<span id='' class='myQuestTextButtonInner'>";g+="<span id='myQuestViewAllXCommentsLink' class='myQuestTextButtonInnerText'>";g+=MessageHelper.format("myQuestUpdatesController_viewAllCommentsX","<span class='commentCount'>"+c+"</span>");g+="</span>";g+="</span></a></div></li></ul>";e+=g;e+="<ul class='myQuestCommentsWrapper myQuestCommentsDisplayed commentHider' id='' style='display:none'>";for(var d=0;d<c-h;d++){var a=ReusableTemplates.load("MyQuestMiniCommentTemplate",n.comments[d]);b+=a}e+=b;e+="</ul>"}e+="<ul class='myQuestCommentsWrapper myQuestCommentsDisplayed' id=''>";var m="";var b="";var m=new Array();var l;var k=c-h;if(k<0){k=0}for(var d=k;d<c;d++){var f=ReusableTemplates.load("MyQuestMiniCommentTemplate",n.comments[d]);m[m.length]=f;if(d==(c-1)){l=n.comments[d].commentID}}for(j=0;j<m.length;j++){e+=m[j]}e+="</ul>";return{html:e,lastDisplayable:l}},expandComments:function(d){var e=Event.element(d);var c=Utility.upToClass(e,"iconExpandComments");if(c){var f=Utility.upToClass(c,"commentSectionWrapper");
var a=Utility.downToClass(f,"commentHider");var b=Utility.upToClass(c,"myQuestCommentsCollapsed");if(b){b.remove()}Effect.BlindDown(a,{duration:0.25})}},registerEvents:function(){var a=$("myQuestViewAllXCommentsLink");if(a){Event.stopObserving("myQuestViewAllXCommentsLink");Event.observe(a,"click",this.expandComments.bindAsEventListener(this))}var c=$("titleDetailLink_"+this.data.record.auditID);if(c){var d=Registry.lookup("TitleDetailsController.Master");var b=d.loadTitleDetails.bind(d,this.data.record.bibID,null);Event.observe("titleDetailLink_"+this.data.record.auditID,"mousedown",b)}}});