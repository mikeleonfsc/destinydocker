Class.create(BaseController,{init:function(){var a=Registry.lookup("MyQuestController.Loader");$("searchtemplate").removeClassName("home");$("searchtemplate").removeClassName("search");$("searchtemplate").addClassName("bookClub");var b=this.data;this.shelfSelect=new ShelfSelect({id:"myQuestMainContent"});this.currentMode=b.mapping;var e=Registry.lookup("MyQuestController.Menu");if(b.inboxCount>=0){e.updateInboxCount(b.inboxCount)}this.records=[];for(i=0;i<this.data.data.dateGroups.length;i++){var c=this.data.data.dateGroups[i];for(j=0;j<c.items.length;j++){var d=c.items[j];this.records.push(d)}}var f=Registry.lookup("HoverMasterController.HoverMaster");this.hoverGroup=f.createGroup({name:this.name,data:this.records,activatorContainer:this.container,hoverContainer:$("content-outer"),controllerURL:this.data.hoverControllerURL,templateURL:this.data.hoverTemplateURL,openDelay:0.5,closeDelay:0.1,onShow:function(){var h=Utility.downToClass($("myQuestShelfHeaderResults"),"high-zindex");if(h){h.removeClassName("high-zindex")
}var g=this.currentActivator.up();g.addClassName("high-zindex");$("content-outer").addClassName("high-zindex")},onHide:function(){$("content-outer").removeClassName("high-zindex")}})},registerEvents:function(){Event.observe($(MyQuestShelfController_DIV_MYQUEST_SHELVES_HEADER_RESULTS),"click",this.doRecommendation.bindAsEventListener(this));Event.observe($(MyQuestShelfController_DIV_MYQUEST_SHELVES_HEADER_RESULTS),"click",this.doReview.bindAsEventListener(this));var d=Registry.lookup("TitleDetailsController.Master");var e=0;for(i=0;i<this.data.data.dateGroups.length;i++){var h=this.data.data.dateGroups[i];for(j=0;j<h.items.length;j++){var k=h.items[j];var b=d.loadTitleDetails.bind(d,k.bibID,null);var a=this.elementMap.get(MyQuestShelfController_AVERAGE_RATING_PREFIX+e);var l=this.elementMap.get(MyQuestShelfController_CLASS_MYQUEST_SHELF_COVER_WRAPPER+e);var g=this.elementMap.get(MyQuestController_ID_TITLE_DETAIL_LINK_PREFIX+k.bibID);var c=this.elementMap.get(MyQuestController_ID_MYQUEST_SHELF_ITEM_REMOVE+e);
if(!k.shelfBib&&a){var f=d.loadTitleDetails.bind(d,k.bibID,TitleDetailsController_DIV_TITLE_DETAIL_TAB_REVIEWS);Event.observe(a,"mousedown",f)}if(l){Event.observe(l,"mousedown",b)}if(g){Event.observe(g,"mousedown",b)}if(c){Event.observe(c,"click",this.removeFromShelf.bind(this,k.bibID,k.shelfNumber))}e++}}},updatePendingReviewForBib:function(a,d){var b=$$(".recordID[value="+a+"]")[0];var c=b.up();var e=Utility.downToClass(c,"myQuestTitleMyRatingWrapper");e.innerHTML='<p><em class="label">'+d+"</em></p>"},updateReviewForBib:function(a,n,d){var k=$$(".recordID[value="+a+"]")[0];var h=k.up();var p=Utility.downToClass(h,"titleDetailsAddReviewClass").down();for(var l=0;l<n;l++){p.children[l].removeClassName("rating_small_empty");p.children[l].addClassName("rating_small_full")}var c=Utility.downToClass(h,"myQuestTitleMyRatingWrapper");var e=c.down("a");if(e){e.update(MessageHelper.format("myQuestShelfController_averageRating",d))}else{var h=Utility.upToClass(c,"myQuestShelfItem");var o=999;if(h){var l=h.identify().indexOf("_");
o=h.identify().substring(l+1)}var f=$(MyQuestController_ID_TITLE_DETAILS_ADD_REVIEW+"_"+o);if(f){f.removeClassName(MyQuestController_CLASS_TITLE_DETAILS_ADD_REVIEW)}var g="averageRating_"+o;c.down().innerHTML+='(<a id="'+g+'" class="titleDetailLink reviewLink" onclick="return false;" href="#">'+MessageHelper.format("myQuestShelfController_averageRating",d)+"</a>)";var b=$(g);if(b){var m=Registry.lookup("TitleDetailsController.Master");if(m){Event.observe(b,"mousedown",m.loadTitleDetails.bind(m,a,TitleDetailsController_DIV_TITLE_DETAIL_TAB_REVIEWS))}}}},removeFromShelf:function(b,a){DAO.load({endpoint:"MyQuestShelfController.ShelfRemove",container:null},b,a)},doRecommendation:function(c){var d=Event.element(c);if(d.hasClassName("shelfListAddRecommendationClass")){var a=d.getAttribute("value");var e={width:"610",id:RecommendationController_DIV_ADD_RECOMMENDATION_DIALOG,zIndex:"50000",hideOnOutsideClick:"true"};var b=new ModalDialog(e);DAO.load({endpoint:"RecommendationController.RecommendationDialog",modal:b},a)
}},doReview:function(b){var d=Event.element(b);var f=d.up().up();if(d.hasClassName("titleDetailsAddReviewClass")||f.hasClassName("titleDetailsAddReviewClass")){var k=Utility.upToClass(d,"myQuestShelfItem");var h=Utility.downToClass(k,"shelfNumber");var l=h.getAttribute("value");var g=Utility.downToClass(k,"recordID");var a=g.getAttribute("value");var e={width:"400",id:ReviewController_DIV_ADD_REVIEW_DIALOG,zIndex:"50000",hideOnOutsideClick:"true"};var c=new ModalDialog(e);DAO.load({endpoint:"ReviewController.ReviewDialog",modal:c},a,l)}},updateShelfResults:function(c,d){for(var b=0;b<this.records.length;b++){var a=this.records[b];if(c.indexOf(a.bibID)>=0){a.inUsersBookList=d}}},getShelfNumber:function(){return this.data.shelfNumber},removeFromShelfCallback:function(b){var a=$$("#"+MyQuestShelfController_DIV_MYQUEST_SHELVES_HEADER_RESULTS+" .recordID[value="+b.bibID+"]");if(a.length!==0){var d=a[0].up();var c=this;Effect.BlindUp(d.id,{duration:0.5,afterFinish:function(){if(d.previous().hasClassName(MyQuestController_CLASS_ACTIVITY_TIMESTAMP)&&(d.next()==undefined||!d.next().hasClassName(MyQuestController_CLASS_MYQUEST_SHELF_ITEM))){d.previous().remove()
}d.remove();var e=Registry.lookup("MyQuestController.Loader");if(e){if($$(".recordID").length==0){e.loadShelf(c.getShelfNumber())}}}})}}});